/*! jquery.dot v0.1.1 | (c) 2016 kamem | https://github.com/kamem/jquery.dot.git */
!function(e,t){"undefined"!=typeof exports?module.exports=t(require("jquery"),e):"function"==typeof define&&define.amd?define(["jquery"],function(){t($,e)}):t($,e)}("undefined"!=typeof window?window:this,function(e,t){!function(){var t,i={},a={},n={},r={},o={};i=function(e){function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();e.Stage=function(){function e(i){t(this,e),this.$el=i,this.pxWidth=10,this.pxHeight=10,this.width=32,this.height=32,this.canvasWidth=this.width*this.pxWidth,this.canvasHeight=this.height*this.pxHeight,this.layers=[],this.layerNum=-1,this.canvas=this.$el.append('<canvas class="layer"></canvas>').find(".layer")[0],this.createNewLayer("#fff"),this.createNewLayer("")}return i(e,[{key:"createNewLayer",value:function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];this.changeLayers({color:e}),this.setLayer({layerNum:this.layerNum})}},{key:"changeBlendMode",value:function(e){var t=e.blendMode,i=void 0===t?0:t;this.layers[this.layerNum].blendMode=i}},{key:"changeOpacity",value:function(e){var t=e.opacity,i=void 0===t?100:t;this.layers[this.layerNum].opacity=i}},{key:"changeStagePxColor",value:function(e){var t=e.pointX,i=e.pointY,a=e.color;this.layers[this.layerNum].ary[i][t]=a}},{key:"getLayerPxColors",value:function(e){var t=this,i=e.pointX,a=e.pointY,n=[];return this.layers.forEach(function(e,r){n.push([e.opacity,e.blendMode,t.getStagePxColor({layerNum:r,pointX:i,pointY:a})])}),n}},{key:"getStagePxColor",value:function(e){var t=e.layerNum,i=void 0===t?this.layerNum:t,a=e.pointX,n=e.pointY;return this.layers[i].ary[n][a]}},{key:"changeLayers",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=e.layers,i=e.color;return t?this.layers=t:(this.layerNum+=1,this.layers[this.layerNum]={},this.changeBlendMode({}),this.changeOpacity({}),void(this.layers[this.layerNum].ary=this.createStageAry(i)))}},{key:"clearLayer",value:function(e){this.layers[this.layerNum].ary=this.createStageAry(e)}},{key:"clearAllLayer",value:function(){var e=this;this.layers.forEach(function(t,i){var a=0===i?"#fff":"";e.layers[i].ary=e.createStageAry(a)})}},{key:"createStageAry",value:function(){for(var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=[],i=0;i<this.height;i++){t[i]=[];for(var a=0;a<this.width;a++)t[i][a]=e}return t}},{key:"changePxSize",value:function(e){var t=e.pxWidth,i=void 0===t?this.pxWidth:t,a=e.pxHeight,n=void 0===a?this.pxHeight:a;this.pxWidth=i,this.pxHeight=n}},{key:"changeSize",value:function(e){var t=e.width,i=void 0===t?this.width:t,a=e.height,n=void 0===a?this.height:a;this.canvasWidth=i*this.pxWidth,this.canvasHeight=n*this.pxHeight}},{key:"setLayer",value:function(e){var t=e.layerNum;this.layerNum=t,this.canvas.width!==this.canvasWidth&&(this.canvas.width=this.canvasWidth),this.canvas.height!==this.canvasHeight&&(this.canvas.height=this.canvasHeight),this.ctx=this.canvas.getContext("2d")}},{key:"setG",value:function(e){this.ctx=e}}]),e}();return e}(i),a=function(e){Object.defineProperty(e,"__esModule",{value:!0});var t=navigator.userAgent;t.match(/iPhone OS (\w+){1,3}/g),t.match(/CPU OS (\w+){1,3}/g);var i=(RegExp.$1.replace(/_/g,"")+"00").slice(0,3),a=e.UA={iPhone:t.search(/iPhone/)!==-1,iPad:t.search(/iPad/)!==-1,Android:t.search(/Android/)!==-1&&t.search(/Mobile/)!==-1&&t.search(/SC-01C/)==-1,AndroidTab:t.search(/Android/)!==-1&&(t.search(/Mobile/)==-1||t.search(/SC-01C/)!==-1),Android3_2:t.search(/Android 3.2/)!==-1,iOS5_less:(t.search(/iPhone/)!==-1||t.search(/iPad/)!==-1)&&i<500,other:!(t.search(/iPhone/)!==-1||t.search(/iPad/)!==-1||t.search(/Android/)!==-1&&t.search(/Mobile/)!==-1&&t.search(/SC-01C/)==-1||t.search(/Android/)!==-1&&(t.search(/Mobile/)==-1||t.search(/SC-01C/)!==-1))},n=e.isMobile=a.iPhone||a.iPad||a.Android||a.AndroidTab;e.EVENT_TYPE={touchStart:n?"touchstart":"mousedown",touchEnd:n?"touchend":"mouseup",touchMove:n?"touchmove":"mousemove"};return e}(a),n=function(e){Object.defineProperty(e,"__esModule",{value:!0});e.BLEND_MODE=[{type:"normal",name:"通常"},{type:"multiply",name:"乗算"},{type:"lighten",name:"比較（明）"},{type:"darken",name:"比較（暗）"},{type:"screen",name:"スクリーン"},{type:"overlay",name:"オーバーレイ"},{type:"hardLight",name:"ハードライト"},{type:"softLight",name:"ソフトライト"},{type:"colorDodge",name:"覆い焼きカラー"},{type:"darken",name:"比較（暗）"}];return e}(n),r=function(e,t){Object.defineProperty(e,"__esModule",{value:!0}),e.selectColor=void 0;var i=function(){function e(e,t){var i=[],a=!0,n=!1,r=void 0;try{for(var o,s=e[Symbol.iterator]();!(a=(o=s.next()).done)&&(i.push(o.value),!t||i.length!==t);a=!0);}catch(h){n=!0,r=h}finally{try{!a&&s["return"]&&s["return"]()}finally{if(n)throw r}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(e){var a=e.color1,n=e.color2,r=i(a,3),o=(r[0],r[1],r[2]),s=i(n,3),h=s[0],l=s[1],c=s[2],u=new RGBColor(o),y=new RGBColor(c),d=[l],f=u.r,g=u.g,v=u.b,p=y.r,w=y.g,S=y.b,k=Math.floor(p*h/100+f*(100-h)/100),m=Math.floor(w*h/100+g*(100-h)/100),x=Math.floor(S*h/100+v*(100-h)/100),b="";switch(t.BLEND_MODE[l].type){case"normal":b="rgb("+[k,m,x].join(",")+")",d.push(c?new RGBColor(b).toHex():o);break;case"multiply":b="rgb("+[Math.floor(f*p/255),Math.floor(g*w/255),Math.floor(v*S/255)].join(",")+")",d.push(c?new RGBColor(b).toHex():o);break;case"lighten":b="rgb("+[p>f?p:f,w>g?w:g,S>v?S:v].join(",")+")",d.push(c?new RGBColor(b).toHex():o);break;case"darken":b="rgb("+[p<f?p:f,w<g?w:g,S<v?S:v].join(",")+")",d.push(c?new RGBColor(b).toHex():o);break;case"screen":b="rgb("+[255-((255-f)*(255-p)>>8),255-((255-g)*(255-w)>>8),255-((255-v)*(255-S)>>8)].join(",")+")",d.push(c?new RGBColor(b).toHex():o);break;default:d.push(c||o)}return d};e.selectColor=function(e){return e.reduce(function(e,t){return a({color1:e,color2:t})})[1]};return e}(r,n),o=function(e,t,i){function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.Oekaki=void 0;var n=function(){function e(e,t){var i=[],a=!0,n=!1,r=void 0;try{for(var o,s=e[Symbol.iterator]();!(a=(o=s.next()).done)&&(i.push(o.value),!t||i.length!==t);a=!0);}catch(h){n=!0,r=h}finally{try{!a&&s["return"]&&s["return"]()}finally{if(n)throw r}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();e.Oekaki=function(){function e(t){var i=t.stage,n=t.strokeStyle,r=t.color,o=void 0===r?"#000":r,s=t.drawingFunction,h=t.endFunction;a(this,e),this.stage=i,this.strokeStyle=n,this.color=o,this.fillStyle=o,this.startX=0,this.startY=0,this.x=0,this.y=0,this.pointX=0,this.pointY=0,this.isDrawing=!1,this.history=[],this.repeatSpeed=10,this.drawingFunction=s,this.endFunction=h}return r(e,[{key:"changeColor",value:function(e){var t=e.color;this.color=t}},{key:"changeFillStyle",value:function(e){var t=e.fillStyle;this.fillStyle=t}},{key:"changeDrawing",value:function(e){this.isDrawing=e}},{key:"changeStartPoint",value:function(e){var t=e.x,i=e.y;this.startX=t,this.startY=i}},{key:"changePoint",value:function(e){var t=e.x,i=e.y;this.x=t,this.y=i}},{key:"changeHistory",value:function(e){this.history=e}},{key:"changeDrawPoint",value:function(){var e=this.getDrawPoint({}),t=e.pointX,i=e.pointY;this.pointX=t,this.pointY=i}},{key:"getDrawPoint",value:function(e){var t=e.x,i=void 0===t?this.x:t,a=e.y,n=void 0===a?this.y:a;return{pointX:Math.floor(i/this.stage.pxWidth),pointY:Math.floor(n/this.stage.pxHeight)}}},{key:"addHistory",value:function(){var e=this.history[this.history.length-1];0!==this.history.length&&e[0]===this.stage.layerNum&&e[1]===this.pointX&&e[2]===this.pointY&&e[3]===this.fillStyle||this.history.push([this.stage.layerNum,this.pointX,this.pointY,this.fillStyle])}},{key:"draw",value:function(e){var t=e.pointX,a=void 0===t?this.pointX:t,n=e.pointY,r=void 0===n?this.pointY:n,o=e.fillStyle,s=(void 0===o?this.fillStyle:o,(0,i.selectColor)(this.stage.getLayerPxColors({pointX:a,pointY:r}))),h=s?"fillRect":"clearRect";this.stage.ctx.fillStyle=s,this.stage.ctx[h](a*this.stage.pxWidth,r*this.stage.pxHeight,this.stage.pxWidth,this.stage.pxHeight)}},{key:"save",value:function(){var e=deflate(JSON.stringify(this.stage.layers)),t=JSON.stringify(this.history);window.location.search=e,localStorage.draw=t}},{key:"load",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?this.stage.layers:arguments[0];t[0].ary.forEach(function(t,i){t.forEach(function(t,a){e.draw({pointX:a,pointY:i,fillStyle:t})})})}},{key:"repeat",value:function(e){var t=this,i=e.speed,a=void 0===i?this.repeatSpeed:i,r=e.history,o=void 0===r?this.history:r;this.clear();for(var s=0,h=0;h<o.length;h++)setTimeout(function(){var e=n(o[s],4),i=e[0],a=e[1],r=e[2],h=e[3];t.stage.setLayer({layerNum:i}),s++,t.stage.changeStagePxColor({pointX:a,pointY:r,color:h}),t.draw({pointX:a,pointY:r,fillStyle:h}),t.drawingFunction&&t.drawingFunction()},a*h)}},{key:"clear",value:function(){this.stage.clearAllLayer(),this.load()}},{key:"setDrawEvent",value:function(){var e=this;this.stage.$el.on(t.EVENT_TYPE.touchStart,function(i){var a=t.isMobile?i.originalEvent.touches[0]:i;e.changeDrawing(!0),e.drawStart({x:a.pageX,y:a.pageY})}).on(t.EVENT_TYPE.touchMove,function(i){if(e.isDrawing){t.isMobile&&event.preventDefault();var a=t.isMobile?i.originalEvent.touches[0]:i;e.drawStart({x:a.pageX,y:a.pageY})}}).on(t.EVENT_TYPE.touchEnd,function(t){e.changeDrawing(!1),e.endFunction&&e.endFunction()}).mouseleave(function(t){e.changeDrawing(!1)})}},{key:"drawStart",value:function(e){var t=e.x,i=e.y;this.changePoint({x:t,y:i}),this.changeStartPoint({x:t,y:i}),this.changeDrawPoint();var a=this.getDrawPoint({}),n=a.pointX,r=a.pointY;this.stage.changeStagePxColor({pointX:n,pointY:r,color:this.fillStyle}),this.draw({}),this.addHistory(),this.drawingFunction&&this.drawingFunction()}}]),e}();return e}(o,a,r),t=function(t,i){e.fn.dot=function(a){var n=e(this),r=e(".mini"),o=new t.Stage(n),s=new t.Stage(r);s.changePxSize({pxWidth:2,pxHeight:2}),s.changeSize({width:32,height:32});var h=window.location.search.substring(1,window.location.search.length),l=inflate(h);window.location.search&&(o.changeLayers({layers:JSON.parse(decodeURI(l.replace(/%23/g,"#")))}),s.changeLayers({layers:JSON.parse(decodeURI(l.replace(/%23/g,"#")))}));var c=new i.Oekaki({stage:s}),u=new i.Oekaki({stage:o,endFunction:function(){s.changeLayers({layers:o.layers}),c.load()}});u.load(),c.load(),u.setDrawEvent(),window.location.search&&u.changeHistory(JSON.parse(localStorage.draw)),e(".save").on("click",function(e){u.save()}),e(".replay").on("click",function(e){u.changeHistory(JSON.parse(localStorage.draw)),u.repeat({})}),e(".num").on("keyup",function(e){o.setLayer({layerNum:parseInt(e.target.value)})}),e(".blend").on("keyup",function(e){o.changeBlendMode({blendMode:parseInt(e.target.value)}),u.load(),c.load()}),e(".addLayer").on("click",function(t){o.createNewLayer(),e(".num").val(o.layerNum)}),e(".opacity").on("keyup",function(e){o.changeOpacity({opacity:parseFloat(e.target.value)}),u.load(),c.load()}),e(".eraser").on("click",function(e){u.changeFillStyle({fillStyle:u.fillStyle?"":u.color})}),e(".color").on("keyup",function(t){console.log(e(".color").val());var i=e(".color").val();u.changeColor({color:i}),u.changeFillStyle({fillStyle:i})})}}(i,o)}()});