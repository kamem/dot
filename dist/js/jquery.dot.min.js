/*! jquery.dot v0.1.1 | (c) 2016 kamem | https://github.com/kamem/jquery.dot.git */
!function(t,e){"undefined"!=typeof exports?module.exports=e(require("jquery"),t):"function"==typeof define&&define.amd?define(["jquery"],function(){e($,t)}):e($,t)}("undefined"!=typeof window?window:this,function(t,e){!function(){var e,i={},n={},a={},r={},o={};i=function(t){function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();t.Stage=function(){function t(i){e(this,t),this.$el=i,this.pxWidth=10,this.pxHeight=10,this.width=32,this.height=32,this.canvasWidth=this.width*this.pxWidth,this.canvasHeight=this.height*this.pxHeight,this.layers=[],this.layerNum=-1,this.canvas=this.$el.append('<canvas class="layer"></canvas>').find(".layer")[0],this.createNewLayer("#fff"),this.createNewLayer("")}return i(t,[{key:"createNewLayer",value:function(){var t=arguments.length<=0||void 0===arguments[0]?"":arguments[0];this.changeLayers({color:t}),this.setLayer({layerNum:this.layerNum})}},{key:"changeBlendMode",value:function(t){var e=t.blendMode,i=void 0===e?0:e;this.layers[this.layerNum].blendMode=i}},{key:"changeOpacity",value:function(t){var e=t.opacity,i=void 0===e?1:e;this.layers[this.layerNum].opacity=i}},{key:"changeStagePxColor",value:function(t){var e=t.pointX,i=t.pointY,n=t.color;this.layers[this.layerNum].ary[i][e]=n}},{key:"getLayerPxColors",value:function(t){var e=this,i=t.pointX,n=t.pointY,a=[];return this.layers.forEach(function(t,r){a.push([t.opacity,t.blendMode,e.getStagePxColor({layerNum:r,pointX:i,pointY:n})])}),a}},{key:"getStagePxColor",value:function(t){var e=t.layerNum,i=void 0===e?this.layerNum:e,n=t.pointX,a=t.pointY;return this.layers[i].ary[a][n]}},{key:"changeLayers",value:function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],e=t.layers,i=t.color;return e?this.layers=e:(this.layerNum+=1,this.layers[this.layerNum]={},this.changeBlendMode({}),this.changeOpacity({}),void(this.layers[this.layerNum].ary=this.createStageAry(i)))}},{key:"clearLayer",value:function(t){this.layers[this.layerNum].ary=this.createStageAry(t)}},{key:"clearAllLayer",value:function(){var t=this;this.layers.forEach(function(e,i){var n=0===i?"#fff":"";t.layers[i].ary=t.createStageAry(n)})}},{key:"createStageAry",value:function(){for(var t=arguments.length<=0||void 0===arguments[0]?"":arguments[0],e=[],i=0;i<this.height;i++){e[i]=[];for(var n=0;n<this.width;n++)e[i][n]=t}return e}},{key:"changePxSize",value:function(t){var e=t.pxWidth,i=void 0===e?this.pxWidth:e,n=t.pxHeight,a=void 0===n?this.pxHeight:n;this.pxWidth=i,this.pxHeight=a}},{key:"changeSize",value:function(t){var e=t.width,i=void 0===e?this.width:e,n=t.height,a=void 0===n?this.height:n;this.canvasWidth=i*this.pxWidth,this.canvasHeight=a*this.pxHeight}},{key:"setLayer",value:function(t){var e=t.layerNum;this.layerNum=e,this.canvas.width!==this.canvasWidth&&(this.canvas.width=this.canvasWidth),this.canvas.height!==this.canvasHeight&&(this.canvas.height=this.canvasHeight),this.ctx=this.canvas.getContext("2d")}},{key:"setG",value:function(t){this.ctx=t}}]),t}();return t}(i),n=function(t){Object.defineProperty(t,"__esModule",{value:!0});var e=navigator.userAgent;e.match(/iPhone OS (\w+){1,3}/g),e.match(/CPU OS (\w+){1,3}/g);var i=(RegExp.$1.replace(/_/g,"")+"00").slice(0,3),n=t.UA={iPhone:e.search(/iPhone/)!==-1,iPad:e.search(/iPad/)!==-1,Android:e.search(/Android/)!==-1&&e.search(/Mobile/)!==-1&&e.search(/SC-01C/)==-1,AndroidTab:e.search(/Android/)!==-1&&(e.search(/Mobile/)==-1||e.search(/SC-01C/)!==-1),Android3_2:e.search(/Android 3.2/)!==-1,iOS5_less:(e.search(/iPhone/)!==-1||e.search(/iPad/)!==-1)&&i<500,other:!(e.search(/iPhone/)!==-1||e.search(/iPad/)!==-1||e.search(/Android/)!==-1&&e.search(/Mobile/)!==-1&&e.search(/SC-01C/)==-1||e.search(/Android/)!==-1&&(e.search(/Mobile/)==-1||e.search(/SC-01C/)!==-1))},a=t.isMobile=n.iPhone||n.iPad||n.Android||n.AndroidTab;t.EVENT_TYPE={touchStart:a?"touchstart":"mousedown",touchEnd:a?"touchend":"mouseup",touchMove:a?"touchmove":"mousemove"};return t}(n),a=function(t){Object.defineProperty(t,"__esModule",{value:!0});t.BLEND_MODE=[{type:"normal",name:"通常"},{type:"multiply",name:"乗算"},{type:"lighten",name:"比較（明）"},{type:"darken",name:"比較（暗）"},{type:"screen",name:"スクリーン"},{type:"overlay",name:"オーバーレイ"},{type:"hardLight",name:"ハードライト"},{type:"softLight",name:"ソフトライト"},{type:"colorDodge",name:"覆い焼きカラー"},{type:"darken",name:"比較（暗）"}];return t}(a),r=function(t,e){Object.defineProperty(t,"__esModule",{value:!0}),t.selectColor=void 0;var i=function(){function t(t,e){var i=[],n=!0,a=!1,r=void 0;try{for(var o,s=t[Symbol.iterator]();!(n=(o=s.next()).done)&&(i.push(o.value),!e||i.length!==e);n=!0);}catch(h){a=!0,r=h}finally{try{!n&&s["return"]&&s["return"]()}finally{if(a)throw r}}return i}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),n=function(t){var e=t.r,n=t.g,a=t.b,r=t.bottomAlpha,o=t.topAlpha,s=i(e,3),h=s[0],l=s[1],c=s[2],u=i(n,3),y=u[0],d=u[1],f=u[2],g=i(a,3),v=g[0],p=g[1],w=g[2],S=o*r,m=o*(1-r),k=(1-o)*r,b=S+m+k;return[Math.floor((S*c+m*l+k*h)/b),Math.floor((S*f+m*d+k*y)/b),Math.floor((S*w+m*p+k*v)/b)]},a=function(t){var a=t.color1,r=t.color2,o=i(a,3),s=o[0],h=(o[1],o[2]),l=i(r,3),c=l[0],u=l[1],y=l[2],d=new RGBColor(h),f=new RGBColor(y),g=[u],v=d.r,p=d.g,w=d.b,S=f.r,m=f.g,k=f.b,b=function(){};switch(e.BLEND_MODE[u].type){case"normal":b=function(t,e){return e};break;case"multiply":b=function(t,e){return t*e/255};break;case"lighten":b=function(t,e){return e>t?e:t};break;case"darken":b=function(t,e){return e<t?e:t};break;case"screen":b=function(t,e){return 255-((255-t)*(255-e)>>8)};break;case"overlay":b=function(t,e){return t>128?e+(2*t-255)-e*(2*t-255)/255:2*e*t/255};break;default:b=function(t,e){return e}}var x=b(v,S),P=b(p,m),N=b(w,k),E=n({r:[v,S,x],g:[p,m,P],b:[w,k,N],bottomAlpha:s,topAlpha:c});return g.push(y?new RGBColor("rgb("+E+")").toHex():h),g};t.selectColor=function(t){return t.reduce(function(t,e){return a({color1:t,color2:e})})[1]};return t}(r,a),o=function(t,e,i){function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.Oekaki=void 0;var a=function(){function t(t,e){var i=[],n=!0,a=!1,r=void 0;try{for(var o,s=t[Symbol.iterator]();!(n=(o=s.next()).done)&&(i.push(o.value),!e||i.length!==e);n=!0);}catch(h){a=!0,r=h}finally{try{!n&&s["return"]&&s["return"]()}finally{if(a)throw r}}return i}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();t.Oekaki=function(){function t(e){var i=e.stage,a=e.strokeStyle,r=e.color,o=void 0===r?"#000":r,s=e.drawingFunction,h=e.endFunction;n(this,t),this.stage=i,this.strokeStyle=a,this.color=o,this.fillStyle=o,this.startX=0,this.startY=0,this.x=0,this.y=0,this.pointX=0,this.pointY=0,this.isDrawing=!1,this.history=[],this.repeatSpeed=10,this.drawingFunction=s,this.endFunction=h}return r(t,[{key:"changeColor",value:function(t){var e=t.color;this.color=e}},{key:"changeFillStyle",value:function(t){var e=t.fillStyle;this.fillStyle=e}},{key:"changeDrawing",value:function(t){this.isDrawing=t}},{key:"changeStartPoint",value:function(t){var e=t.x,i=t.y;this.startX=e,this.startY=i}},{key:"changePoint",value:function(t){var e=t.x,i=t.y;this.x=e,this.y=i}},{key:"changeHistory",value:function(t){this.history=t}},{key:"changeDrawPoint",value:function(){var t=this.getDrawPoint({}),e=t.pointX,i=t.pointY;this.pointX=e,this.pointY=i}},{key:"getDrawPoint",value:function(t){var e=t.x,i=void 0===e?this.x:e,n=t.y,a=void 0===n?this.y:n;return{pointX:Math.floor(i/this.stage.pxWidth),pointY:Math.floor(a/this.stage.pxHeight)}}},{key:"addHistory",value:function(){var t=this.history[this.history.length-1];0!==this.history.length&&t[0]===this.stage.layerNum&&t[1]===this.pointX&&t[2]===this.pointY&&t[3]===this.fillStyle||this.history.push([this.stage.layerNum,this.pointX,this.pointY,this.fillStyle])}},{key:"draw",value:function(t){var e=t.pointX,n=void 0===e?this.pointX:e,a=t.pointY,r=void 0===a?this.pointY:a,o=t.fillStyle,s=(void 0===o?this.fillStyle:o,(0,i.selectColor)(this.stage.getLayerPxColors({pointX:n,pointY:r}))),h=s?"fillRect":"clearRect";this.stage.ctx.fillStyle=s,this.stage.ctx[h](n*this.stage.pxWidth,r*this.stage.pxHeight,this.stage.pxWidth,this.stage.pxHeight)}},{key:"save",value:function(){var t=deflate(JSON.stringify(this.stage.layers)),e=JSON.stringify(this.history);window.location.search=t,localStorage.draw=e}},{key:"load",value:function(){var t=this,e=arguments.length<=0||void 0===arguments[0]?this.stage.layers:arguments[0];e[0].ary.forEach(function(e,i){e.forEach(function(e,n){t.draw({pointX:n,pointY:i,fillStyle:e})})})}},{key:"repeat",value:function(t){var e=this,i=t.speed,n=void 0===i?this.repeatSpeed:i,r=t.history,o=void 0===r?this.history:r;this.clear();for(var s=0,h=0;h<o.length;h++)setTimeout(function(){var t=a(o[s],4),i=t[0],n=t[1],r=t[2],h=t[3];e.stage.setLayer({layerNum:i}),s++,e.stage.changeStagePxColor({pointX:n,pointY:r,color:h}),e.draw({pointX:n,pointY:r,fillStyle:h}),e.drawingFunction&&e.drawingFunction()},n*h)}},{key:"clear",value:function(){this.stage.clearAllLayer(),this.load()}},{key:"setDrawEvent",value:function(){var t=this;this.stage.$el.on(e.EVENT_TYPE.touchStart,function(i){var n=e.isMobile?i.originalEvent.touches[0]:i;t.changeDrawing(!0),t.drawStart({x:n.pageX,y:n.pageY})}).on(e.EVENT_TYPE.touchMove,function(i){if(t.isDrawing){e.isMobile&&event.preventDefault();var n=e.isMobile?i.originalEvent.touches[0]:i;t.drawStart({x:n.pageX,y:n.pageY})}}).on(e.EVENT_TYPE.touchEnd,function(e){t.changeDrawing(!1),t.endFunction&&t.endFunction()}).mouseleave(function(e){t.changeDrawing(!1)})}},{key:"drawStart",value:function(t){var e=t.x,i=t.y;this.changePoint({x:e,y:i}),this.changeStartPoint({x:e,y:i}),this.changeDrawPoint();var n=this.getDrawPoint({}),a=n.pointX,r=n.pointY;this.stage.changeStagePxColor({pointX:a,pointY:r,color:this.fillStyle}),this.draw({}),this.addHistory(),this.drawingFunction&&this.drawingFunction()}}]),t}();return t}(o,n,r),e=function(e,i){t.fn.dot=function(n){var a=t(this),r=t(".mini"),o=new e.Stage(a),s=new e.Stage(r);s.changePxSize({pxWidth:2,pxHeight:2}),s.changeSize({width:32,height:32});var h=window.location.search.substring(1,window.location.search.length),l=inflate(h);window.location.search&&(o.changeLayers({layers:JSON.parse(decodeURI(l.replace(/%23/g,"#")))}),s.changeLayers({layers:JSON.parse(decodeURI(l.replace(/%23/g,"#")))}));var c=new i.Oekaki({stage:s}),u=new i.Oekaki({stage:o,endFunction:function(){s.changeLayers({layers:o.layers}),c.load()}});u.load(),c.load(),u.setDrawEvent(),window.location.search&&u.changeHistory(JSON.parse(localStorage.draw)),t(".save").on("click",function(t){u.save()}),t(".replay").on("click",function(t){u.changeHistory(JSON.parse(localStorage.draw)),u.repeat({})}),t(".num").on("keyup",function(t){o.setLayer({layerNum:parseInt(t.target.value)})}),t(".blend").on("keyup",function(t){o.changeBlendMode({blendMode:parseInt(t.target.value)}),u.load(),c.load()}),t(".addLayer").on("click",function(e){o.createNewLayer(),t(".num").val(o.layerNum)}),t(".opacity").on("keyup",function(t){o.changeOpacity({opacity:parseFloat(t.target.value)}),u.load(),c.load()}),t(".eraser").on("click",function(t){u.changeFillStyle({fillStyle:u.fillStyle?"":u.color})}),t(".color").on("keyup",function(e){console.log(t(".color").val());var i=t(".color").val();u.changeColor({color:i}),u.changeFillStyle({fillStyle:i})})}}(i,o)}()});